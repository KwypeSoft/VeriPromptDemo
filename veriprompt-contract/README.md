# VeriPrompt Contract

Owner-mediated ERC-721 minting flow that stores on-chain file integrity hashes for verified prompts.

## Highlights

- **Owner-only minting:** All tokens must be minted via the contract owner, enabling a relayer or custodial workflow.
- **On-chain integrity:** Each token stores a `bytes32` file hash that can be queried at any time to verify provenance.
- **Supply control:** Hard cap enforced by `MAX_SUPPLY` so no more than the configured number of NFTs can ever exist.
- **Security hardened:** Uses OpenZeppelin `Ownable`, `ERC721URIStorage`, and `ReentrancyGuard`; emits detailed events for every mint.
- **Tooling ready:** Scripts cover deployment, ABI extraction, and owner relayed minting to streamline operations.

## Prerequisites

- Node.js 18 (or newer) with npm 9+
- Git and a funded Sepolia account for deployment testing
- Windows PowerShell (commands below assume the default shell)

## Install & Build

Clone the repository, install dependencies, and compile the contracts:

```powershell
npm install
npx hardhat compile
```

Run the security-oriented test suite:

```powershell
npx hardhat test
```

## Environment Configuration

Multiple environments are supported via layered `.env` files. Copy the template and fill in secrets before running any scripts.

```powershell
Copy-Item .env.local.template .env.local
```

Populate **all** of the following keys:

| Variable | Purpose |
| --- | --- |
| `PRIVATE_KEY` | Sepolia deployer key (used by Hardhat scripts) |
| `OWNER_ADDRESS` | Expected owner address for contract verification |
| `ALCHEMY_SEPOLIA_URL` / `INFURA_SEPOLIA_URL` | RPC endpoints (at least one required) |
| `ETHERSCAN_API_KEY` | Optional, for contract verification |

The loader pulls from `.env.local` first, then `.env`, ensuring local overrides without committing secrets.

## Contract Overview

File: `contracts/VeriPrompt.sol`

- `safeMint(address to, string memory uri, bytes32 fileHash)` is restricted to `onlyOwner` and protected by `nonReentrant`.
- `_tokenHash[tokenId]` records the hash linked to each token and is exposed via `tokenHash(uint256 tokenId)`.
- `TokenMinted` event emits `tokenId`, recipient, metadata URI, and file hash for external indexers.
- `MAX_SUPPLY` enforces the supply ceiling; minting reverts once reached.

Look up the ABI anytime via `abi/VeriPrompt.abi.json` (generated by the extraction script detailed below).

## Deployment (Sepolia)

1. Ensure your deployer wallet matches `OWNER_ADDRESS` and has Sepolia ETH.
2. Run the deployment script; it validates RPC connectivity, signer balance, and owner consistency before broadcasting.

```powershell
npx tsx scripts/deploy-veriprompt.ts
```

3. Record the contract address output by the script; it is written to the console only.
4. (Optional) Verify on Etherscan once funded by running Hardhat's verify task.

## Hashing Assets

Minting requires a 32-byte keccak256 hash. Use the helper below to hash any local file:

```powershell
node -e "const { createHash } = require('crypto'); const fs = require('fs'); const path = process.argv[1]; const data = fs.readFileSync(path); const hash = '0x' + createHash('sha3-256').update(data).digest('hex'); console.log(hash);" .\path\to\asset.json
```

Verify the hash is **exactly** 66 characters (0x + 64 hex chars). Any other length will revert.

## Minting Tokens

### Option 1: Owner Relayer Script (Recommended)

The owner can mint on behalf of users and have the token delivered directly to them.

```powershell
npx tsx scripts/mint-on-behalf.ts --contract 0xYourContract --to 0xRecipient --uri https://gateway.pinata.cloud/ipfs/... --hash 0xFileHash
```

- The script loads RPC URLs, owner key, and contract address from the environment (flags take precedence).
- Output includes the transaction hash, decoded `TokenMinted` data, and stored file hash for quick validation.

### Option 2: Direct Contract Call

Interact with the deployed contract in any wallet/DApp capable of calling `safeMint`. You must be the owner and supply the same `to`, `uri`, and `bytes32` hash arguments described above.

## ABI Extraction

Generate or refresh the ABI artifacts after contract changes:

```powershell
npx tsx scripts/extract-abi.ts
```

Outputs:

- `abi/VeriPrompt.abi.json` â€“ full ABI
- `abi/VeriPrompt.min.json` â€“ events + mint function only (suitable for lightweight clients)

## Troubleshooting

- **`CALL_EXCEPTION` while minting:** Check that the caller is the contract owner and the file hash is 32 bytes with a `0x` prefix.
- **Signer mismatch during deployment:** The deploy script compares your signer address to `OWNER_ADDRESS`; confirm they match exactly (case-sensitive).
- **Gas estimation errors:** Ensure the destination address is valid and the token supply limit has not been reached.
- **Environment not loading:** Confirm `.env.local` exists and the script is executed from the repository root.

## Security Notes

- Contract is covered by targeted tests focusing on access control, non-reentrancy, hash integrity, and supply limits (see `test/VeriPrompt.security.test.ts`).
- Reentrancy protection is enabled on the mint function even though it is owner-only, preventing future regressions if transfer hooks are expanded.
- No upgradeability pattern is usedâ€”redeploy to modify logic.

## License

## ðŸ“„ License

Released under the [MIT License](LICENSE). You may use, modify, and distribute this project freely, including in commercial applications, provided the original copyright notice and this permission notice are included.